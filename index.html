<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NiBdy Archive</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; width: 100%; }
    
    /* Header */
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; }
    
    /* Navigation */
    nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    nav a {
      background: rgba(255,255,255,0.2);
      padding: 0.6rem 1.2rem;
      border-radius: 25px;
      color: white;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }
    nav a:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
    
    /* Search Bar */
    .search-container {
      max-width: 600px;
      margin: 0 auto 1.5rem;
      display: flex;
      gap: 0.5rem;
    }
    #search-input {
      flex: 1;
      padding: 0.8rem 1.2rem;
      border: none;
      border-radius: 25px;
      font-size: 1rem;
      outline: none;
    }
    #search-btn, #upload-btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 25px;
      background: white;
      color: #667eea;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    #upload-btn { background: #4CAF50; color: white; }
    #search-btn:hover, #upload-btn:hover { transform: scale(1.05); }
    
    /* Upload Form */
    #upload-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #upload-modal.active { display: flex; }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-content h2 { margin-bottom: 1.5rem; color: #333; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #555;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
    }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-group input[type="file"] { padding: 0.5rem; }
    .btn-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    .btn {
      flex: 1;
      padding: 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-secondary { background: #ccc; color: #333; }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); }
    
    /* Content Area */
    main { flex: 1; padding: 2rem 0; }
    .section-header {
      text-align: center;
      margin-bottom: 2rem;
      color: #333;
    }
    
    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    /* Card */
    .card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .card-media {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 3rem;
    }
    .card-media img,
    .card-media video { width: 100%; height: 100%; object-fit: cover; }
    .card-body { padding: 1.5rem; flex: 1; }
    .card-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #333;
    }
    .card-author {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    .card-description {
      font-size: 0.9rem;
      color: #777;
      margin-bottom: 1rem;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .card-footer {
      padding: 1rem 1.5rem;
      background: #f9f9f9;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: #888;
    }
    .card-tag {
      background: #667eea;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.8rem;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #999;
    }
    .empty-state h3 { font-size: 1.5rem; margin-bottom: 1rem; }
    .empty-state button {
      margin-top: 1rem;
      padding: 1rem 2rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    .empty-state button:hover { transform: scale(1.05); }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #667eea;
      font-size: 1.2rem;
    }
    
    /* Footer */
    footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 2rem 0;
      margin-top: 3rem;
    }
    footer a { color: #667eea; text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    
    /* Responsive */
    @media (max-width: 768px) {
      h1 { font-size: 1.5rem; }
      nav { gap: 0.5rem; }
      nav a { padding: 0.5rem 1rem; font-size: 0.9rem; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
      .modal-content { padding: 1.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>NiBdy: Archiving our way</h1>
      <nav>
        <a onclick="showHome()">Home</a>
        <a onclick="filterSection('literature')">Literature</a>
        <a onclick="filterSection('audio')">Audio</a>
        <a onclick="filterSection('visual art')">Visual Art</a>
        <a onclick="filterSection('performance art')">Performance Art</a>
        <a onclick="filterSection('articles')">Articles</a>
      </nav>
      <div class="search-container">
        <input type="text" id="search-input" placeholder="Search by title, author, or subsection...">
        <button id="search-btn" onclick="performSearch()">üîç</button>
        <button id="upload-btn" onclick="toggleUpload()">Upload</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div id="section-header" class="section-header"></div>
      <div id="content" class="grid"></div>
      <div id="loading" class="loading" style="display: none;">Loading materials...</div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2024 NiBdy Archive. Preserving marginalised voices.</p>
      <p style="margin-top: 0.5rem;">This site is powered by <a href="https://www.netlify.com" target="_blank" rel="noopener">Netlify</a></p>
    </div>
  </footer>

  <!-- Upload Modal -->
  <div id="upload-modal">
    <div class="modal-content">
      <h2>Archive New Material</h2>
      <form id="upload-form" onsubmit="handleUpload(event)">
        <div class="form-group">
          <label for="file">File *</label>
          <input type="file" id="file" name="file" required>
          <small style="color: #888;">Max size: 5MB. Formats: images, videos, audio, PDFs, text files</small>
        </div>
        
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" name="title" required placeholder="What is this work called?">
        </div>
        
        <div class="form-group">
          <label for="author">Author *</label>
          <textarea id="author" name="author" required placeholder="Who owns this work?"></textarea>
        </div>
        
        <div class="form-group">
          <label for="description">Description *</label>
          <textarea id="description" name="description" required placeholder="Helps for accessibility purposes too."></textarea>
        </div>
        
        <div class="form-group">
          <label for="section">Section *</label>
          <select id="section" name="section" required onchange="updateSubsections()">
            <option value="">Select Section</option>
            <option value="literature">Literature</option>
            <option value="audio">Audio</option>
            <option value="visual art">Visual Art</option>
            <option value="performance art">Performance Art</option>
            <option value="articles">Articles</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="subsection">Subsection *</label>
          <select id="subsection" name="subsection" required onchange="toggleOtherField()">
            <option value="">Select Subsection</option>
          </select>
        </div>
        
        <div class="form-group" id="other-field" style="display: none;">
          <label for="other-subsection">Please specify *</label>
          <input type="text" id="other-subsection" name="other-subsection" placeholder="What type of work is this?">
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="toggleUpload()">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const sections = {
      literature: ['Fiction', 'Nonfiction', 'Drama', 'Poetry', 'Film Scripts', 'Folklore', 'Other'],
      audio: ['Sound Poetry', 'Experimental Sound', 'Music', 'Podcast', 'Oral Histories', 'Other'],
      'visual art': ['Paintings', 'Photographs', 'Digital Art', 'Textile Art', 'Films', 'Sculpture', 'Other'],
      'performance art': ['Dance', 'Theatre', 'Installations', 'Other'],
      articles: ['Editorials', 'Research', 'Reviews', 'Case Studies', 'Reports', 'Opinions', 'Other']
    };

    const allowedTypes = [
      'image/jpeg', 'image/png', 'image/gif', 'image/webp',
      'video/mp4', 'video/webm',
      'audio/mpeg', 'audio/wav', 'audio/ogg',
      'text/plain', 'application/pdf'
    ];

    const maxFileSize = 5 * 1024 * 1024; // 5MB
    let currentFilter = null;
    let allMaterials = [];

    // Update subsections based on selected section
    function updateSubsections() {
      const sectionSelect = document.getElementById('section');
      const subsectionSelect = document.getElementById('subsection');
      subsectionSelect.innerHTML = '<option value="">Select Subsection</option>';
      
      const subs = sections[sectionSelect.value] || [];
      subs.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.text = s;
        subsectionSelect.appendChild(opt);
      });
      
      // Hide "Other" field when section changes
      document.getElementById('other-field').style.display = 'none';
      document.getElementById('other-subsection').value = '';
    }

    // Toggle "Other" field when "Other" is selected
    function toggleOtherField() {
      const subsectionSelect = document.getElementById('subsection');
      const otherField = document.getElementById('other-field');
      const otherInput = document.getElementById('other-subsection');
      
      if (subsectionSelect.value === 'Other') {
        otherField.style.display = 'block';
        otherInput.required = true;
      } else {
        otherField.style.display = 'none';
        otherInput.required = false;
        otherInput.value = '';
      }
    }

    // Toggle upload modal
    function toggleUpload() {
      const modal = document.getElementById('upload-modal');
      modal.classList.toggle('active');
      if (!modal.classList.contains('active')) {
        document.getElementById('upload-form').reset();
      }
    }

    // Handle file upload
    async function handleUpload(event) {
      event.preventDefault();
      
      const form = event.target;
      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a file');
        return;
      }

      if (!allowedTypes.includes(file.type)) {
        alert('Invalid file type. Allowed: images, videos, audio, PDFs, and text files');
        return;
      }

      if (file.size > maxFileSize) {
        alert('File too large. Maximum size is 5MB');
        return;
      }

      // Show loading
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';

      try {
        // Convert file to base64
        const base64 = await fileToBase64(file);
        
        // Get subsection value (use custom "Other" value if applicable)
        let subsectionValue = document.getElementById('subsection').value;
        if (subsectionValue === 'Other') {
          subsectionValue = document.getElementById('other-subsection').value.trim();
        }
        
        // Create material object
        const material = {
          id: Date.now().toString(),
          title: document.getElementById('title').value.trim(),
          author: document.getElementById('author').value.trim(),
          description: document.getElementById('description').value.trim(),
          section: document.getElementById('section').value,
          subsection: subsectionValue,
          type: file.type,
          dateArchived: new Date().toISOString(),
          fileData: base64
        };

        // Save to shared storage
        await window.storage.set(`material:${material.id}`, JSON.stringify(material), true);
        
        alert('Material archived successfully!');
        toggleUpload();
        form.reset();
        await loadMaterials();
      } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to upload material. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
      }
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Load all materials from storage
    async function loadMaterials() {
      const loading = document.getElementById('loading');
      const content = document.getElementById('content');
      
      loading.style.display = 'block';
      content.innerHTML = '';

      try {
        const result = await window.storage.list('material:', true);
        
        if (!result || !result.keys || result.keys.length === 0) {
          allMaterials = [];
          displayMaterials([]);
          return;
        }

        // Load all materials
        const materials = [];
        for (const key of result.keys) {
          try {
            const data = await window.storage.get(key, true);
            if (data && data.value) {
              materials.push(JSON.parse(data.value));
            }
          } catch (error) {
            console.error('Error loading material:', error);
          }
        }

        // Sort by date (newest first)
        materials.sort((a, b) => new Date(b.dateArchived) - new Date(a.dateArchived));
        
        allMaterials = materials;
        displayMaterials(materials);
      } catch (error) {
        console.error('Error loading materials:', error);
        content.innerHTML = '<div class="empty-state"><h3>Error loading materials</h3><p>Please refresh the page</p></div>';
      } finally {
        loading.style.display = 'none';
      }
    }

    // Display materials
    function displayMaterials(materials) {
      const content = document.getElementById('content');
      const header = document.getElementById('section-header');
      
      if (currentFilter) {
        header.innerHTML = `<h2>${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)}</h2>`;
      } else {
        header.innerHTML = '<h2>All Materials</h2>';
      }

      if (materials.length === 0) {
        const emptyMsg = currentFilter 
          ? `No materials in ${currentFilter} yet.`
          : 'No materials archived yet.';
        content.innerHTML = `
          <div class="empty-state">
            <h3>${emptyMsg}</h3>
            <p>Be the first to preserve some!</p>
            <button onclick="toggleUpload()">Add Material</button>
          </div>
        `;
        return;
      }

      content.innerHTML = materials.map(m => createCard(m)).join('');
    }

    // Create material card
    function createCard(material) {
      const date = new Date(material.dateArchived).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      let mediaHtml = '';
      if (material.type.startsWith('image/')) {
        mediaHtml = `<img src="${material.fileData}" alt="${material.title}">`;
      } else if (material.type.startsWith('video/')) {
        mediaHtml = `<video src="${material.fileData}"></video>`;
      } else if (material.type.startsWith('audio/')) {
        mediaHtml = '<div style="font-size: 4rem;">üéµ</div>';
      } else if (material.type === 'application/pdf') {
        mediaHtml = '<div style="font-size: 4rem;">üìÑ</div>';
      } else {
        mediaHtml = '<div style="font-size: 4rem;">üìù</div>';
      }

      return `
        <div class="card" onclick="viewMaterial('${material.id}')">
          <div class="card-media">${mediaHtml}</div>
          <div class="card-body">
            <div class="card-title">${escapeHtml(material.title)}</div>
            <div class="card-author">By ${escapeHtml(material.author)}</div>
            <div class="card-description">${escapeHtml(material.description)}</div>
          </div>
          <div class="card-footer">
            <span class="card-tag">${material.subsection}</span>
            <span>${date}</span>
          </div>
        </div>
      `;
    }

    // View material details
    function viewMaterial(id) {
      const material = allMaterials.find(m => m.id === id);
      if (!material) return;

      let viewContent = '';
      if (material.type.startsWith('image/')) {
        viewContent = `<img src="${material.fileData}" style="max-width: 100%; border-radius: 8px;">`;
      } else if (material.type.startsWith('video/')) {
        viewContent = `<video src="${material.fileData}" controls style="max-width: 100%; border-radius: 8px;"></video>`;
      } else if (material.type.startsWith('audio/')) {
        viewContent = `<audio src="${material.fileData}" controls style="width: 100%;"></audio>`;
      } else if (material.type === 'application/pdf' || material.type === 'text/plain') {
        viewContent = `<a href="${material.fileData}" target="_blank" class="btn btn-primary" style="display: inline-block; text-decoration: none;">Open File</a>`;
      }

      const modal = document.createElement('div');
      modal.id = 'view-modal';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; padding: 20px;';
      modal.innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
          <h2 style="margin-bottom: 1rem;">${escapeHtml(material.title)}</h2>
          <p style="color: #666; margin-bottom: 0.5rem;"><strong>Author:</strong> ${escapeHtml(material.author)}</p>
          <p style="color: #666; margin-bottom: 0.5rem;"><strong>Section:</strong> ${material.section} - ${material.subsection}</p>
          <p style="color: #666; margin-bottom: 1rem;"><strong>Archived:</strong> ${new Date(material.dateArchived).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
          <p style="margin-bottom: 1.5rem; line-height: 1.6;">${escapeHtml(material.description)}</p>
          ${viewContent}
          <button onclick="document.getElementById('view-modal').remove()" class="btn btn-secondary" style="width: 100%; margin-top: 1.5rem;">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Filter by section
    function filterSection(section) {
      currentFilter = section;
      const filtered = allMaterials.filter(m => m.section === section);
      displayMaterials(filtered);
    }

    // Show home
    function showHome() {
      currentFilter = null;
      displayMaterials(allMaterials);
    }

    // Perform search
    function performSearch() {
      const query = document.getElementById('search-input').value.trim().toLowerCase();
      
      if (!query) {
        displayMaterials(allMaterials);
        return;
      }

      const results = allMaterials.filter(m => 
        m.title.toLowerCase().includes(query) ||
        m.author.toLowerCase().includes(query) ||
        m.subsection.toLowerCase().includes(query) ||
        m.description.toLowerCase().includes(query)
      );

      currentFilter = null;
      document.getElementById('section-header').innerHTML = `<h2>Search Results: "${escapeHtml(query)}"</h2>`;
      displayMaterials(results);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch();
    });

    loadMaterials();
  </script>
</body>
</html>
