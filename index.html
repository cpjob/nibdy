<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReclaimArchive</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 2vw; 
      font-size: 16px;
    }
    h1 { font-size: 1.5rem; text-align: center; }
    header { 
      background: #f0f0f0; 
      padding: 2vw; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
    }
    nav { 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      margin-bottom: 2vw; 
    }
    nav a { 
      margin: 1vw; 
      text-decoration: none; 
      color: blue; 
      cursor: pointer; 
      font-size: 1rem; 
      padding: 0.5rem; 
    }
    #search { 
      display: flex; 
      width: 100%; 
      max-width: 500px; 
      margin: 1vw 0; 
    }
    #search-input { 
      flex-grow: 1; 
      padding: 0.5rem; 
      font-size: 1rem; 
      border: 1px solid #ccc; 
      border-radius: 4px 0 0 4px; 
    }
    #search-btn { 
      padding: 0.5rem 1rem; 
      font-size: 1rem; 
      border: 1px solid #ccc; 
      border-left: none; 
      background: #fff; 
      cursor: pointer; 
    }
    #upload-btn { 
      padding: 0.5rem 1rem; 
      font-size: 1rem; 
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      margin-top: 1vw; 
      min-height: 48px; 
    }
    #upload-dropdown { 
      display: none; 
      border: 1px solid #ccc; 
      padding: 2vw; 
      margin-top: 2vw; 
      background: #fff; 
      border-radius: 4px; 
    }
    #upload-form { 
      display: flex; 
      flex-direction: column; 
      gap: 1vw; 
    }
    #upload-form input, #upload-form select { 
      padding: 0.5rem; 
      font-size: 1rem; 
      width: 100%; 
      max-width: 500px; 
      box-sizing: border-box; 
    }
    #upload-form button { 
      padding: 0.5rem; 
      font-size: 1rem; 
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      min-height: 48px; 
    }
    #content { 
      margin-top: 2vw; 
      display: flex; 
      flex-direction: column; 
      gap: 2vw; 
    }
    .file { 
      border: 1px solid #ddd; 
      padding: 2vw; 
      border-radius: 5px; 
      width: 100%; 
      box-sizing: border-box; 
    }
    .file img, .file video, .file audio { 
      max-width: 100%; 
      height: auto; 
      display: block; 
      margin-top: 1vw; 
    }
    .file a { 
      color: blue; 
      text-decoration: none; 
    }
    #modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      justify-content: center; 
      align-items: center; 
    }
    #modal-content { 
      background: white; 
      padding: 4vw; 
      border-radius: 5px; 
      text-align: center; 
      max-width: 80%; 
    }
    #modal-content button { 
      margin: 1vw; 
      padding: 0.5rem 1rem; 
      font-size: 1rem; 
      cursor: pointer; 
      min-height: 48px; 
    }
    #modal-add { 
      background: #007bff; 
      color: white; 
      border: none; 
    }
    #modal-cancel { 
      background: #ccc; 
      border: none; 
    }
    @media (max-width: 600px) {
      nav { 
        flex-direction: column; 
        align-items: center; 
      }
      nav a { 
        margin: 0.5vw 0; 
        font-size: 0.9rem; 
      }
      #search-input, #search-btn, #upload-btn, #upload-form input, #upload-form select, #upload-form button { 
        font-size: 0.9rem; 
      }
      #modal-content { 
        max-width: 90%; 
        padding: 5vw; 
      }
    }
  </style>
</head>
<body>
  <h1>NiBdy: Digital Archiving for Marginalised Individuals</h1>
  <header>
    <nav>
      <a onclick="browse('literature')">Literature</a>
      <a onclick="browse('audio')">Audio</a>
      <a onclick="browse('visual art')">Visual Art</a>
      <a onclick="browse('performance art')">Performance Art</a>
      <a onclick="browse('articles')">Articles</a>
    </nav>
    <div id="search">
      <input type="text" id="search-input" placeholder="Search...">
      <button id="search-btn" onclick="search()">üîç</button>
    </div>
    <button id="upload-btn" onclick="toggleUpload()">Upload</button>
  </header>
  <div id="upload-dropdown">
    <form id="upload-form">
      <input type="file" name="file" required>
      <input type="text" name="customName" placeholder="Custom Name (searchable)" required>
      <select name="section" required>
        <option value="">Select Section</option>
        <option value="literature">Literature</option>
        <option value="audio">Audio</option>
        <option value="visual art">Visual Art</option>
        <option value="performance art">Performance Art</option>
        <option value="articles">Articles</option>
      </select>
      <select name="subsection" required>
        <option value="">Select Subsection</option>
      </select>
      <button type="button" onclick="uploadFile()">Submit</button>
    </form>
  </div>
  <div id="content"></div>
  <div id="modal">
    <div id="modal-content">
      <p>No archived material...yet. Do you want to aid in the preservation of some?</p>
      <button id="modal-add" onclick="modalAdd()">Add Material</button>
      <button id="modal-cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <script>
    const sections = {
      literature: ['Poetry', 'Prose', 'Essays'],
      audio: ['Music', 'Podcasts', 'Oral Histories'],
      'visual art': ['Paintings', 'Photographs', 'Digital Art', 'Textile Art', 'Films'],
      'performance art': ['Dance', 'Theatre', 'Installations'],
      articles: ['News', 'Opinion', 'Research']
    };
    const allowedTypes = [
      'image/jpeg', 'image/png', 'image/gif',
      'video/mp4', 'video/mpeg',
      'audio/mpeg', 'audio/wav',
      'text/plain', 'application/pdf'
    ];
    const maxFileSize = 5 * 1024 * 1024; // 5MB
    const maxTotalStorage = 5 * 1024 * 1024; // 5MB total

    function toggleUpload() {
      try {
        const dd = document.getElementById('upload-dropdown');
        if (dd) {
          dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
        }
      } catch (e) {
        alert('Error toggling upload form: ' + e.message);
      }
    }

    function showModal() {
      try {
        const modal = document.getElementById('modal');
        if (modal) {
          modal.style.display = 'flex';
        }
      } catch (e) {
        alert('Error showing modal: ' + e.message);
      }
    }

    function closeModal() {
      try {
        const modal = document.getElementById('modal');
        if (modal) {
          modal.style.display = 'none';
        }
      } catch (e) {
        alert('Error closing modal: ' + e.message);
      }
    }

    function modalAdd() {
      try {
        closeModal();
        toggleUpload();
      } catch (e) {
        alert('Error opening upload form: ' + e.message);
      }
    }

    function getStorageSize() {
      try {
        let total = 0;
        for (let x in localStorage) {
          if (localStorage.hasOwnProperty(x)) {
            total += ((localStorage[x].length + x.length) * 2);
          }
        }
        return total;
      } catch (e) {
        alert('Error calculating storage size: ' + e.message);
        return 0;
      }
    }

    function uploadFile() {
      try {
        const form = document.getElementById('upload-form');
        if (!form) throw new Error('Upload form not found');
        const fileInput = form.querySelector('[name="file"]');
        const customName = form.querySelector('[name="customName"]').value.trim();
        const section = form.querySelector('[name="section"]').value;
        const subsection = form.querySelector('[name="subsection"]').value;
        const file = fileInput.files[0];

        if (!file || !customName || !section || !subsection) {
          alert('Please fill all fields');
          return;
        }

        if (!allowedTypes.includes(file.type)) {
          alert('Invalid file type. Allowed: images, videos, audio, text, PDFs');
          return;
        }

        if (file.size > maxFileSize) {
          alert('File too large. Max size is 5MB');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const dataUrl = e.target.result;
            const metadata = JSON.parse(localStorage.getItem('archive_metadata') || '[]');
            const newSize = getStorageSize() + dataUrl.length * 2;
            if (newSize > maxTotalStorage) {
              alert('Storage limit reached (5MB total). Please clear some files.');
              return;
            }

            const fileId = Date.now().toString();
            metadata.push({
              filename: fileId,
              customName,
              section,
              subsection,
              type: file.type
            });
            localStorage.setItem('archive_metadata', JSON.stringify(metadata));
            localStorage.setItem(`file_${fileId}`, dataUrl);
            alert('Uploaded successfully!');
            toggleUpload();
            loadFiles();
          } catch (e) {
            alert('Error saving file: ' + e.message);
          }
        };
        reader.onerror = function() {
          alert('Error reading file. Please try another file.');
        };
        reader.readAsDataURL(file);
      } catch (e) {
        alert('Error uploading file: ' + e.message);
      }
    }

    function loadFiles(query = '') {
      try {
        const metadata = JSON.parse(localStorage.getItem('archive_metadata') || '[]');
        const content = document.getElementById('content');
        if (!content) throw new Error('Content area not found');
        content.innerHTML = '';
        const q = query.toLowerCase();
        const files = q ? metadata.filter(m => 
          (m.customName && m.customName.toLowerCase().includes(q)) || 
          (m.section && m.section.toLowerCase().includes(q)) || 
          (m.subsection && m.subsection.toLowerCase().includes(q))
        ) : metadata;

        if (files.length === 0 && query) {
          showModal();
        }
        if (files.length === 0 && !query) {
          content.innerHTML = '<p>No materials archived yet. Start uploading!</p>';
        }

        files.forEach(f => {
          try {
            const div = document.createElement('div');
            div.className = 'file';
            div.innerHTML = `<h3>${f.customName || 'Unnamed'}</h3><p>${f.section || ''} - ${f.subsection || ''}</p>`;
            const dataUrl = localStorage.getItem(`file_${f.filename}`);
            if (!dataUrl) {
              div.innerHTML += '<p>File data missing</p>';
            } else if (f.type && f.type.startsWith('image/')) {
              div.innerHTML += `<img src="${dataUrl}" alt="${f.customName || 'Unnamed'}">`;
            } else if (f.type && f.type.startsWith('video/')) {
              div.innerHTML += `<video src="${dataUrl}" controls></video>`;
            } else if (f.type && f.type.startsWith('audio/')) {
              div.innerHTML += `<audio src="${dataUrl}" controls></audio>`;
            } else if (f.type && (f.type.startsWith('text/') || f.type === 'application/pdf')) {
              div.innerHTML += `<a href="${dataUrl}" target="_blank">View File</a>`;
            } else {
              div.innerHTML += `<a href="${dataUrl}" download>Download</a>`;
            }
            content.appendChild(div);
          } catch (e) {
            console.error('Error rendering file:', e);
          }
        });
      } catch (e) {
        alert('Error loading files: ' + e.message);
      }
    }

    function search() {
      try {
        const q = document.getElementById('search-input').value.trim();
        if (!q) {
          alert('Please enter a search term');
          return;
        }
        loadFiles(q);
      } catch (e) {
        alert('Error searching: ' + e.message);
      }
    }

    function browse(section) {
      try {
        loadFiles(section);
      } catch (e) {
        alert('Error browsing section: ' + e.message);
      }
    }

    try {
      const sectionSelect = document.querySelector('[name="section"]');
      const subSelect = document.querySelector('[name="subsection"]');
      if (sectionSelect && subSelect) {
        sectionSelect.onchange = () => {
          try {
            subSelect.innerHTML = '<option value="">Select Subsection</option>';
            const subs = sections[sectionSelect.value] || [];
            subs.forEach(s => {
              const opt = document.createElement('option');
              opt.value = s;
              opt.text = s;
              subSelect.appendChild(opt);
            });
          } catch (e) {
            alert('Error updating subsections: ' + e.message);
          }
        };
      }
      loadFiles();
    } catch (e) {
      alert('Error initializing app: ' + e.message);
    }
  </script>
</body>
</html>